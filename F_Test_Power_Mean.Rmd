---
title: "F Test Power Simulation - Mean"
author: "Jingyang(Judy) Zhang"
date: "10/25/2021"
output: html_document
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```



```{r load_pkg}
library(tidyverse)
library(ggpubr)
library(pwr)
```

# Introduction

## Setup

Treatment Group Sample Observations: $Y_{1j}\stackrel{iid}\sim N(\mu_{1}, \sigma_{1}^{2})$, $j = 1, ..., n_{1}$.

Control Group Sample Observations: $Y_{0j}\stackrel{iid}\sim N(\mu_{0}, \sigma_{0}^{2})$, $j = 1, ..., n_{0}$.

Total Number of Groups: $k = 2$

Total Number of Observations: $N = \sum_{i=1}^{k}n_{i}$


Sample Means: 

$\bar{Y}_{i.} = \frac{1}{n_{i}}\sum_{j=1}^{n_{i}}Y_{ij}$: sample mean for group $i$. 

$\bar{Y}_{..} = \frac{1}{N}\sum_{i=1}^{k}\sum_{j=1}^{n_{i}}Y_{ij}$: sample grand mean for all observations in k samples. 

**Assumptions:**

1. Two populations (i.e. treatment group and control group) are independent.

2. Assume equal sample size: $n_{0} = n_{1} = n$.

3. Assume equal population variance: $\sigma_{1}^{2} = \sigma_{0}^{2} = \sigma^{2}$.


## F-Test for Equality of Population Means 

**Hypothesis:**

$H_0: \mu_{0} = \mu_{1}$

$H_{a}: \mu_{0}\neq\mu_{1}$

**Test Statistic:**

$F = \frac{MST}{MSE} = \frac{SST/(k-1)}{SSE/(N-k)}$$\stackrel{H_0}\sim F_{(k-1),(N-k)}$

where $k=2$ is number of groups (i.e. here we have two group, treatment and control);

$SST = \sum_{i=1}^{k}n_{i}(\bar{Y}_{i.} - \bar{Y}_{..})^{2} = \sum_{i=1}^{2}n(\bar{Y}_{i.} - \bar{Y}_{..})^{2}$ is total sum of squares between groups;

$k-1 = 2-1 = 1$ is degrees of freedom for SST;

$SSE = \sum_{i=1}^{k}\sum_{j=1}^{n_{i}}(Y_{ij} - \bar{Y}_{i.})^{2}$ is total sum of squares within groups.  

$N-k = 2n - 2$ is degrees of freedom for SSE.

**Effect Size:**

As we are assuming two populations have the same variance, the population standardized mean difference will be given by:


$\delta = \frac{\mu_{1} - \mu_{0}}{\sigma}


**Decision Rule:**

For a given significance level $\alpha$, we reject $H_{0}$ if:

$F > F_{(k-1),(N-k)}(\alpha)$

**Power:**

For a given significance level $\alpha$, the power of the F-test is given by:

$\text{Power} = P(\text{Reject H_{0}}|\text{H_{a} is true})$

Under $H_{a}$, $F = \frac{MST}{MSE}$ follows a non-central $F_{(k-1),(N-k)}$ with a non-centrality parameter given by:

$\delta = \sum_{i=1}^{k}\frac{n_{i}(\mu_{i} - \mu)^{2}}{\sigma^{2}} = \sum_{i=1}^{k}\frac{n(\mu_{i} - \mu)^{2}}{\sigma^{2}} = \sum_{i=1}^{k}\frac{(\mu_{i}-\mu)^{2}}{(\frac{\sigma}{\sqrt{n}})^2}$ where

$\mu_{i}$ is population mean for group $i$ and $\mu = \frac{1}{N}\sum_{i=1}^{k}n_{i}\mu_{i}$ is the population grand mean. 


# Purpose 

In this simulation, we calculate power of F-Test for equality of population means with different combinations of values of the four parameters:

$n_{0} = n_{1} = n$: sample size of control/treatment group. 

$\mu_{0}$: population mean of control group. 

$\mu_{1}$: population mean of treatment group. 

$\sigma^{2}$: population variance of control/treatment group.




# Functions

**Function cal_power_mean():** calculates power for a two-sided F-test for equality of two population means. 

Arguments: 
mean1_popl: population mean for the treatment group.
mean0_popl: population mean for the control group. 
var_popl: population variance for the control/treatment group (as we assume the two populations have the same variance).
n: sample size for the control/treatment group (as we assume the two samples have the same size).
alpha: significance level for the F-test of equality of two population means. 

Return:
power: calculated power for the F-test for equality of two population means. 


```{r cal_power_mean}

cal_power_mean <- function(mean1_popl, mean0_popl, var_popl, n, alpha){
  
 
  
  mu <- (1/(2*n))*(n*mean1_popl + n*mean0_popl)
  
  delta <- n*(mean1_popl - mu)^2/var_popl + n*(mean0_popl - mu)^2/var_popl
  
  
  F_crit_up <- qf(1 - alpha, 2-1, 2*n-2, lower.tail = TRUE, log.p = FALSE)
  
  power <- pf(F_crit_up, 2-1, 2*n-2, ncp = delta, lower.tail = FALSE, log.p = FALSE)
  
  return(power)
  
  
}


```


**Test cal_power_mean() Function:**


Test Data:
$Y_{0j}\sim N(0, 1)$ 

$Y_{1j}\sim N(10, 1)$  

$n_0 = n_1 = 30$

$\alpha = 0.05$

```{r test_cal_power_mean}


mean1_popl <- 0.1

mean0_popl <- 0

var_popl <- 1

n <- 15

alpha <- 0.5




cal_power_mean(mean1_popl, mean0_popl, var_popl, n, alpha)

```



**Function simulate_power_mean():** calculate powers for different values of parameters.

Arguments:

mean1popls: a vector containing a list of population means for different treatment groups. 

mean0popls: a vector containing a list of population means for different control groups. 

varpopls: a vector containing a list of sample variances for different treatment group samples. 


ns: a vector containing a list of sample sizes for different treatment/control group samples. 


alphas: a vector containing a list of significance levels. 


Return: 
result_table: a tibble containing parameters and corresponding power of the F test. 



```{r simulate_power_mean}

simulate_power_mean <- function(mean1popls, mean0popls, varpopls, ns, alphas){
  
  powers <- c()
  
  for(i in 1:length(mean1popls)){
    
    powers[i] <- cal_power_mean(mean1popls[i], mean0popls[i], varpopls[i], ns[i], alphas[i])
    
  }
  
  # Result table will provide four parameters and corresponding power: mu1 (population mean for the treatment group), mu0 (population mean for the control group), n (sample size for control/treatment group), sigma2 (population variance for control/treatment group) and power
  
  result_table <- tibble(mu1 = mean1popls, mu0 = mean0popls, sigma2 = varpopls, n = ns, power = powers)
  
  return(result_table)
  
  
}


```



**Test simulate_power_mean() Function:**


Test Data:

$Y_{0j}\sim N(0, 1$ 

$Y_{1j}\sim N(1, 1), N(-0.1, 1), N(0.1, 1)$  

$n_0 = n_1 = 30$ or $15$

$\alpha = 0.05$

```{r test_simulate_power_mean}

mean1popls <- c(1, -0.1, 0.1)

mean0popls <- c(0, 0, 0)

varpopls <- c(1, 1, 1)

ns <- c(30, 30, 15)

alphas <- c(0.05, 0.05, 0.05)




result_table_mean <- simulate_power_mean(mean1popls, mean0popls, varpopls, ns, alphas)

result_table_mean


```



**Function cal_sampleSize_var():** calculates the minimum sample size n per group required for the F-test for equality of two population means to have a certain given power. 

**Note:** the F-test for equality of two population means is equivalent to the two-sample t test for population means.

Arguments: 
delta: effect size for the F-test for equality of two population means.
power: power of the two-sided F test for equality of two population means.
alpha: significance level for the F-test of equality of two population means. 

Return:
n: minimum sample size per group required for the F-test for equality of two population means to reach the given power. 


```{r cal_sampleSize_mean}

cal_sampleSize_mean <- function(delta, power, alpha){
  
  
  
  n_min <- round(as.numeric(pwr.t.test(d=delta, sig.level=alpha, power=power, type="two.sample", alternative="two.sided")$n))
  
  return(n_min)
}


```


**Test Function cal_sampleSize_mean() Function:**

Test Data:

$\delta = 0.1$

$\alpha = 0.05$

$power = 0.8$

```{r test_cal_effectSize_mean}


delta <- 0.1


alpha <- 0.05

power <- 0.8


n_min <- cal_sampleSize_mean(delta, power, alpha)

n_min


```














# Exploration

## Sample Size v.s. Power (for given population means, $\mu_1$, $\mu_0$, and population variance, $\sigma^2$)


Test Data:

Control Group: $Y_{0j}\stackrel{iid}\sim N(0, 1)$
Treatment Group: $Y_{1j}\stackrel{iid}\sim N(0.5, 1)$
Significance Level: $\alpha = 0.05$
Sample Size: $n_0 = n_1 = n = 5, 60, 115, 170, 225, 280, 335, 490, 445, 500$


```{r explore_sample_size}


mean1popls <- rep(0.5, 10)

mean0popls <- rep(0, 10)

varpopls <- rep(1, 10)

alphas <- rep(0.05, 10)

ns <- seq(5, 500, length.out = 10)



result_table_mean <- simulate_power_mean(mean1popls, mean0popls, varpopls, ns, alphas)

result_table_mean


ggplot(data = result_table_mean, aes(x = n, y = power)) + 
  geom_point() +  
  scale_x_continuous(limits = c(5, 500)) + 
  scale_y_continuous(limits = c(0, 1)) + 
  geom_hline(yintercept = 0.8, linetype = "dashed", color = "red")
  



```

