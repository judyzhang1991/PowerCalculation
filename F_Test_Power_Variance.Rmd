---
title: "F Test Power Simulation - Variance"
author: "Jingyang(Judy) Zhang"
date: "10/25/2021"
output: html_document
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```



```{r load_pkg}
library(tidyverse)
library(ggpubr)
```

# Introduction

## Setup

Treatment Group Sample Observations: $Y_{1j}\stackrel{iid}\sim N(\mu_{1}, \sigma_{1}^{2})$, $j = 1, ..., n_{1}$.

Control Group Sample Observations: $Y_{0j}\stackrel{iid}\sim N(\mu_{0}, \sigma_{0}^{2})$, $j = 1, ..., n_{0}$.

Total Number of Groups: $k = 2$

Total Number of Observations: $N = \sum_{i=1}^{k}n_{i}$

Sample Means: 

$\bar{Y}_{i.} = \frac{1}{n_{i}}\sum_{j=1}^{n_{i}}Y_{ij}$: sample mean for group $i$. 

Sample Variances: 

$s^{2}_{i} = \frac{1}{n-1}\sum_{j=1}^{n_{i}}(Y_{ij} - \bar{Y}_{i.})^{2}$: sample variance for group $i$. 


**Assumptions:**

1. Two populations (i.e. treatment group and control group) are independent.

2. Assume equal sample size: $n_{0} = n_{1} = n$.

3. Assume equal population mean: $\mu_{1} = \mu_{0} = \mu$.




## F-Test for Equality of Population Variances 

**Hypothesis:**

$H_0: \sigma^{2}_{0} = \sigma^{2}_{1}$

$H_{a}: \sigma^{2}_{0}\neq\sigma^{2}_{1}$
 
**Test Statistic:**

$F = \frac{\text{SSE}_{1}/(n-1)}{\text{SSE}_{0}/(n-1)}$

where $\text{SSE}_{i}$ is the sum of error squares for group $i$;

$n_{0} - 1 = n_{1} - 1 = n - 1$ is the degrees of freedom for group $i$.


**Decision Rule:**

For a given significance level $\alpha$, we reject $H_{0}$ if:

$F > F_{(n-1),(n-1)}(\alpha)$


**Power:**

For a given significance level $\alpha$, the power of the F-test is given by:

$\text{Power} = P(\text{Reject} H_{0}|H_{a} \text{is true})$

Under $H_{a}$, $F = \frac{\text{SSE}_{1}/(n-1)}{\text{SSE}_{0}/(n-1)}$ follows a non-central $F_{(n-1),(n-1)}$ with a non-centrality parameter given by:

$\phi = \frac{\sigma_1^2}{\sigma_0^2}$: ratio of population variances of the treatment group over the control group.


The power thus can be calculated by:

$\text{Power} = P(\text{Reject} H_{0}|H_{a} \text{is true})$

$ = P(F > \phi F_{n -1, n -1})$ 



# Purpose 

In this simulation, we calculate power of F-Test for equality of population variance with different combinations of values of the two parameters:

$n_{0} = n_{1} = n$: sample size of control/treatment group. 

$\phi = \frac{\sigma^{2}_{1}}{\sigma^{2}_{0}}$: ratio of population variances of the treatment group over the control group. 


# Functions

**Function cal_power_var():** calculates power for a two-sided F-test for equality of two variances. 

Arguments: 
var1_popl: population variance for the treatment group.
var0_popl: population variance for the control group. 
var1: sample variance for the treatment group.
n0: sample size for the control group. 
alpha: significance level for the F-test of equality of two population variances. 

Return:
power: calculated power for the F-test for equality of two variances. 


```{r cal_power_var, results='hide'}

cal_power_var <- function(var1_popl, var0_popl, n1, n0, alpha){
  
  
  
  phi <- var1_popl/var0_popl
  
  F_crit_low <- qf(alpha/2, n1-1, n0-1, lower.tail = TRUE, log.p = FALSE)
  
  F_crit_up <- qf(1 - alpha/2, n1-1, n0-1, lower.tail = TRUE, log.p = FALSE)
  
  p_low <- pf(phi*F_crit_low, n1-1, n0-1, lower.tail = TRUE, log.p = FALSE)
  
  p_up <- pf(phi*F_crit_up, n1-1, n0-1, lower.tail = FALSE, log.p = FALSE)
  
  power <- p_low + p_up
  
  return(power)
  
  
}


```


**Test cal_power_var() Function:**


Test Data:

$Y_{0j}\sim N(0, 180)$ 

$Y_{1j}\sim N(0, 175)$  

$n_0 = n_1 = 30$

$\alpha = 0.05$

```{r test_cal_power_var}

var1_popl <- 180
var0_popl <- 175
mu1 <- 0
mu0 <- 0 


n1 <- 30
n0 <- 30



cal_power_var(var1_popl, var0_popl, n1, n0, 0.05)

```




**Function simulate_power_var():** calculate powers for different values of parameters.

Arguments:

var1popls: a vector containing a list of population variances for different treatment groups. 

var0popls: a vector containing a list of population variances for different control groups. 


n1s: a vector containing a list of sample sizes for different treatment group samples. 

n0s: a vector containing a list of sample sizes for different treatment group samples. 

alphas: a vector containing a list of significance levels. 


Return: 
result_table: a tibble containing parameters and corresponding power of the F test. 



```{r simulate_power_var}

simulate_power_var <- function(var1popls, var0popls, n1s, n0s, alphas){
  
  
  power <- c()
  
  for(i in 1:length(var1popls)){
    
    power[i] <- cal_power_var(var1popls[i], var0popls[i], n1s[i], n0s[i], alphas[i])
    
  }
  
  # Result table will provide three parameters and corresponding power: phi, n1, n0, and power
  
  if(all(n1s == n0s)){
    
    result_table <- tibble(phi = var1popls/var0popls, n = n1s, power = power)
    
  }else{
    
    result_table <- tibble(phi = var1popls/var0popls, n1 = n1s, n0 = n0s, power = power)
    
  }
  
  return(result_table)
  
  
}


```


**Test simulate_power_mean() Function:**


Test Data:
$Y_{0j}\sim N(0, \sigma_^{2}_{0})$ 

$Y_{1j}\sim N(0, \sigma_^{2}_{1})$ 

$\phi = \frac{\sigma^{2}_{1}}{\sigma^{2}_{0}} = 10/15, 20/21$

$n_0 = n_1 = 30$

$\alpha = 0.05$

```{r test_simulate_power_var}

var1popls <- c(10, 20)
var0popls <- c(15, 21)
mu1 <- 0
mu0 <- 0 


n1s <- c(30, 30)
n0s <- c(30, 30)


alphas <- c(0.05, 0.05)


result_table <- simulate_power_var(var1popls, var0popls, n1s, n0s, alphas)

result_table
```




**Function cal_effectSize_var():** calculates effect size phi for a two-sided F-test for equality of two variances. 

Arguments: 
n1: sample size for the treatment group.
n0: sample size for the control group. 
power: power of the two-sided F test for equality of two population variances.
alpha: significance level for the F-test of equality of two population variances. 

Return:
phi = $\frac{\sigma_1^2}{\sigma_0^2}$: calculated power for the F-test for equality of two variances. 


```{r cal_effectSize_var}
cal_effectSize_var <- function(n1, n0, power, alpha){
  
  
  
  F_crit_low <- qf(alpha/2, n1-1, n0-1, lower.tail = TRUE, log.p = FALSE)
  
  F_crit_up <- qf(1 - alpha/2, n1-1, n0-1, lower.tail = TRUE, log.p = FALSE)
  
  p_low <- pf(F_crit_low, n1-1, n0-1, lower.tail = TRUE, log.p = FALSE)
  
  p_up <- pf(F_crit_up, n1-1, n0-1, lower.tail = FALSE, log.p = FALSE)
  
  phi <- power / (p_low + p_up)
  
  return(phi)
  
  
}
```



**Test Function cal_effectSize_var() Function:**

Test Data:

$n_0 = n_1 = 30$

$\alpha = 0.05$

$power = 0.8$

```{r test_cal_effectSize_var}


n1 <- 30

n0 <- 30


alphas <- 0.05

power <- 0.8


phi <- cal_effectSize_var(n1, n0, power, alpha)

phi


```



# Exploration

## Sample Size v.s. Power (for given population variances, $\sigma^{2}_1$, $\sigma^{2}_0$, and population means, $\mu_{1} = \mu_{0} = \mu$)

Test Data:

Control Group: $Y_{0j}\stackrel{iid}\sim N(0, 1)$
Treatment Group: $Y_{1j}\stackrel{iid}\sim N(0, 1.5)$
Significance Level: $\alpha = 0.05$
Sample Size: $n_0 = n_1 = n = 5, 60, 115, 170, 225, 280, 335, 490, 445, 500$


```{r explore_sample_size}


var1popls <- rep(1.5, 10)
var0popls <- rep(1, 10)
mu1 <- 0
mu0 <- 0 

alphas <- rep(0.05, 10)


ns <- seq(5, 500, length.out = 10)






result_table_var <- simulate_power_var(var1popls, var0popls, ns, ns, alphas)

result_table_var 


ggplot(data = result_table_var, aes(x = n1, y = power)) + 
  geom_point() +  
  scale_x_continuous(limits = c(5, 500)) + 
  scale_y_continuous(limits = c(0, 1)) + 
  geom_hline(yintercept = 0.8, linetype = "dashed", color = "red")
  



```

```{r simulate}


var1popls <- seq(10, 1, by = - 0.01)
var0popls <- rep(10, length(var1popls))
mu1 <- 0
mu0 <- 0 


n1s <- rep(30, length(var1popls))
n0s <- rep(30, length(var1popls))




alphas<- rep(0.05, length(var1popls))


result_table_phi <- simulate_power_var(var1popls, var0popls, n1s, n0s, alphas)


```





Plot phi v.s. power

```{r plot_phi}

ggplot(result_table_phi, aes(x = phi, y = power)) + 
  geom_point() + 
  scale_x_continuous(breaks = seq(0, 1, by = 0.05)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05))
  theme(axis.text.x = element_text(angle = 295, vjust = 0.5, hjust=1))

```

1. As $\phi\rightarrow 1$, power declines.

2. As $\phi\rightarrow 1$, the rate of decline of the power increases and then decreases.

3. As $\phi\rightarrow 1$, the power decreases faster for $\phi\in [0.30, 0.60]$ than for $\phi\in (0, 0.30)\cup(0.6, 1)$.




## Different Sample Sizes with the Same Phi

```{r simulate_sample_sizes}

n1s <- seq(10, 100, by = 1)
n0s <- rep(100, length(n1s))

var1popls <- rep(5, length(n1s))
var0popls <- rep(10, length(n1s))
mu1 <- 0
mu0 <- 0 




alphas <- rep(0.05, length(n1s))


result_table_size <- simulate_power_var(var1popls, var0popls, n1s, n0s, alphas)


```



Plot sample size v.s. power

```{r plot_sample_size}

ggplot(result_table_size, aes(x = n1/n0, y = power)) + 
  geom_point() + 
  scale_x_continuous(breaks = seq(0, 1, by = 0.05)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05))
  theme(axis.text.x = element_text(angle = 295, vjust = 0.5, hjust=1))

```

1. As $\frac{n_1}{n_0}\rightarrow 1$, power increases. 

2. As $\frac{n_1}{n_0}\rightarrow 1$, the rate of increase of power decreases. 





## Sample Size, Phi and Power


### $\phi = 0.95$
```{r simulate_samplesize_phi95}


n1s <- seq(10, 200, by = 1)
n0s <- n1s

var1popls <- rep(9.5, length(n1s))
var0popls <- rep(10, length(n1s))
mu1 <- 0
mu0 <- 0 





alphas <- rep(0.05, length(n1s))


result_table_phi95 <- simulate_power_var(var1popls, var0popls, n1s, n0s, alphas)



```




Plot sample size v.s. power for $\phi = 0.95$

```{r plot_samplesize_phi95}

phi95 <- ggplot(result_table_phi95, aes(x = n1, y = power)) + 
  geom_point() + 
  scale_x_continuous(breaks = seq(5, 210, by = 10)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.001)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
phi95

```

1. As $n_1 = n_0 = n\rightarrow 1$, power increases. 

2. As $n_1 = n_0 = n\rightarrow 1$, the rate of increase of power decreases. 





### $\phi = 0.9$
```{r simulate_samplesize_phi90}


n1s <- seq(10, 200, by = 1)
n0s <- n1s

var1popls <- rep(9, length(n1s))
var0popls <- rep(10, length(n1s))
mu1 <- 0
mu0 <- 0 





alphas <- rep(0.05, length(n1s))


result_table_phi90 <- simulate_power_var(var1popls, var0popls, n1s, n0s, alphas)



```




Plot sample size v.s. power for $\phi = 0.9$

```{r plot_samplesize_phi90}

phi90 <- ggplot(result_table_phi90, aes(x = n1, y = power)) + 
  geom_point() + 
  scale_x_continuous(breaks = seq(5,230, by = 10)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.01)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
phi90

```

1. As $n_1 = n_0 = n\rightarrow 1$, power increases. 

2. As $n_1 = n_0 = n\rightarrow 1$, the rate of increase of power decreases. 




### $\phi = 0.7$
```{r simulate_samplesize_phi70}


n1s <- seq(10, 200, by = 1)
n0s <- n1s

var1popls <- rep(7, length(n1s))
var0popls <- rep(10, length(n1s))
mu1 <- 0
mu0 <- 0 






alphas <- rep(0.05, length(n1s))


result_table_phi70 <- simulate_power_var(var1popls, var0popls, n1s, n0s, alphas)



```




Plot sample size v.s. power for $\phi = 0.7$

```{r plot_samplesize_phi70}

phi70 <- ggplot(result_table_phi70, aes(x = n1, y = power)) + 
  geom_point() + 
  scale_x_continuous(breaks = seq(5, 210, by = 10)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
phi70

```

1. As $n_1 = n_0 = n\rightarrow 1$, power increases. 

2. As $n_1 = n_0 = n\rightarrow 1$, the rate of increase of power decreases. 



### $\phi = 0.5$
```{r simulate_samplesize_phi50}


n1s <- seq(10, 200, by = 1)
n0s <- n1s

var1popls <- rep(5, length(n1s))
var0popls <- rep(10, length(n1s))
mu1 <- 0
mu0 <- 0 



alphas <- rep(0.05, length(n1s))


result_table_phi50 <- simulate_power_var(var1popls, var0popls, n1s, n0s, alphas)



```




Plot sample size v.s. power for $\phi = 0.5$

```{r plot_samplesize_phi50}

phi50 <- ggplot(result_table_phi50, aes(x = n1, y = power)) + 
  geom_point() + 
  scale_x_continuous(breaks = seq(5, 210, by = 10)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
phi50

```

1. As $n_1 = n_0 = n\rightarrow 1$, power increases. 

2. As $n_1 = n_0 = n\rightarrow 1$, the rate of increase of power decreases. 




Compare

```{r plots_samplesize_phi}

ggarrange(phi95, phi90, phi70, phi50,
          labels = c("phi = 0.95", "phi = 0.9", "phi = 0.7", "phi = 0.5"),
          label.x = 0.5,
          label.y = 0.5,
          font.label = list(size = 12),
          ncol = 2, nrow = 2)




```


1. One obvious pattern is that for any given sample size n, the larger the $\phi$, the smaller the power. 


2. For large value of $\phi$, the effect of increasing sample size n on increasing the power is about the same for small and large sample sizes. 

3. For small value of $\phi$, there is a diminishing effect of increasing sample size n on increasing the power. That is, as sample size gets larger, the increase in power gets smaller. 


In general, as $\phi$ decreases, the relationship between sample size n and power goes from a linear function to a concave function. 

